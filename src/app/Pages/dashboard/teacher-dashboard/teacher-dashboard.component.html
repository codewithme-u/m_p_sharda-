<div class="d-flex" id="wrapper">
  <!-- SIDEBAR -->
  <div class="bg-white border-end sticky-top" style="min-width: 260px; height: 100vh; overflow-y: auto">
    <div class="sidebar-heading text-center py-4 border-bottom mb-3">
      <div class="fw-bold text-primary fs-4">
        <i class="bi bi-mortarboard-fill me-2"></i>Faculty Portal
      </div>
      <small class="text-muted">Instructor Access</small>
    </div>

    <!-- Institution Info -->
    <div class="text-center px-3 mb-4" *ngIf="currentUser.institutionId">
      <img *ngIf="institutionDetails.instituteImage" [src]="institutionDetails.instituteImage"
        class="rounded-circle border shadow-sm mb-2" width="70" height="70" style="object-fit: cover"
        onerror="this.src='assets/img/default-institution.png'" />
      <h6 class="fw-bold text-dark m-0">
        {{ institutionDetails.instituteName }}
      </h6>
      <small class="text-muted">{{
        institutionDetails.instituteLocation
        }}</small>
    </div>

    <div class="list-group list-group-flush px-2">
      <button class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'dashboard'" (click)="switchView('dashboard')">
        <i class="bi bi-grid-1x2-fill me-2"></i> Dashboard
      </button>
      <button class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'exams'" (click)="switchView('exams')">
        <i class="bi bi-file-earmark-text me-2"></i> Exam Management
      </button>
      <button class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'reports'" (click)="switchView('reports')">
        <i class="bi bi-graph-up-arrow me-2"></i> Gradebook & Reports
      </button>
      <button class="list-group-item list-group-item-action border-0 rounded mb-2"
        [class.active-tab]="currentView === 'settings'" (click)="switchView('settings')">
        <i class="bi bi-gear me-2"></i> Profile & Settings
      </button>

      <button class="list-group-item list-group-item-action text-danger border-0 mt-5" (click)="logout()">
        <i class="bi bi-box-arrow-left me-2"></i> Logout
      </button>
    </div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div id="page-content-wrapper" class="w-100 bg-light">
    <!-- TOP NAVBAR -->
    <nav class="navbar navbar-light bg-white border-bottom shadow-sm px-4 py-3">
      <div class="d-flex align-items-center">
        <h5 class="m-0 fw-bold text-dark text-uppercase">{{ currentView }}</h5>
      </div>
      <div class="ms-auto d-flex align-items-center cursor-pointer" (click)="switchView('settings')">
        <div class="text-end me-3 d-none d-md-block">
          <div class="fw-bold text-dark">{{ currentUser.name }}</div>
          <div class="small text-muted">{{ currentUser.email }}</div>
        </div>
        <img *ngIf="currentUser.profileImageUrl" [src]="currentUser.profileImageUrl" class="rounded-circle border"
          width="40" height="40" style="object-fit: cover" onerror="this.src='assets/img/default-avatar.png'" />
        <div *ngIf="!currentUser.profileImageUrl"
          class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center fw-bold"
          style="width: 40px; height: 40px">
          {{ currentUser.name.charAt(0) | uppercase }}
        </div>
      </div>
    </nav>

    <div class="container-fluid p-4">
      <!-- 1. DASHBOARD OVERVIEW -->
      <div *ngIf="currentView === 'dashboard'" class="animate__animated animate__fadeIn">
        <!-- Metrics Cards -->
        <div class="row g-4 mb-4">
          <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 p-3 border-start border-4 border-primary">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted text-uppercase small mb-1">
                    Active Exams
                  </h6>
                  <h2 class="mb-0 fw-bold text-dark">{{ myQuizzes.length }}</h2>
                </div>
                <div class="bg-primary-subtle text-primary rounded-circle p-3">
                  <i class="bi bi-file-text fs-4"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 p-3 border-start border-4 border-success">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted text-uppercase small mb-1">
                    Total Attempts
                  </h6>
                  <h2 class="mb-0 fw-bold text-dark">{{ totalStudents }}</h2>
                </div>
                <div class="bg-success-subtle text-success rounded-circle p-3">
                  <i class="bi bi-people fs-4"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 p-3 border-start border-4 border-warning">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="text-muted text-uppercase small mb-1">
                    Avg. Performance
                  </h6>
                  <h2 class="mb-0 fw-bold text-dark">78%</h2>
                </div>
                <div class="bg-warning-subtle text-warning rounded-circle p-3">
                  <i class="bi bi-graph-up-arrow fs-4"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <h5 class="fw-bold mb-3">Quick Actions</h5>
            <div class="d-flex gap-3">
              <button class="btn btn-primary px-4" (click)="openCreateModal()">
                <i class="bi bi-plus-lg me-2"></i>Create Exam
              </button>
              <button class="btn btn-outline-secondary px-4" (click)="switchView('reports')">
                <i class="bi bi-clipboard-data me-2"></i>View Reports
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 2. EXAMS MANAGEMENT -->
      <div *ngIf="currentView === 'exams'" class="animate__animated animate__fadeIn">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="fw-bold m-0">My Exams</h4>
          <button class="btn btn-primary shadow-sm" (click)="openCreateModal()">
            + Create New Exam
          </button>
        </div>

        <div class="row g-4">
          <div class="col-xl-4 col-md-6" *ngFor="let quiz of myQuizzes">
            <div class="card h-100 border-0 shadow-sm hover-card">
              <div class="card-body p-4 d-flex flex-column">
                <div class="d-flex justify-content-between mb-3">
                  <span class="badge" [ngClass]="quiz.active ? 'bg-success' : 'bg-secondary'">{{ quiz.active ? "Active"
                    : "Draft" }}</span>
                  <div class="dropdown">
                    <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                      <li>
                        <button class="dropdown-item" (click)="copyLink(quiz.code)">
                          Copy Link
                        </button>
                      </li>
                      <li>
                        <button class="dropdown-item" (click)="toggleQuizStatus(quiz)">
                          {{ quiz.active ? "Deactivate" : "Activate" }}
                        </button>
                      </li>
                      <li>
                        <hr class="dropdown-divider" />
                      </li>
                      <li>
                        <button class="dropdown-item text-danger" (click)="deleteQuiz(quiz.id)">
                          Delete
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>

                <h5 class="card-title fw-bold mb-1">{{ quiz.title }}</h5>
                <p class="text-muted small mb-3 line-clamp-2">
                  {{ quiz.description }}
                </p>

                <div class="mt-auto">
                  <div class="d-flex justify-content-between small text-muted mb-3">
                    <span><i class="bi bi-hash"></i> {{ quiz.code }}</span>
                    <span><i class="bi bi-question-circle"></i>
                      {{ quiz.questionsCount }} Qs</span>
                    <span><i class="bi bi-clock"></i>
                      {{ quiz.timeLimit || 60 }}m</span>
                  </div>
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" [routerLink]="['/quiz-builder', quiz.id]">
                      <i class="bi bi-pencil-square me-1"></i> Edit Questions
                    </button>
                    <button class="btn btn-outline-dark btn-sm" (click)="openReportModal(quiz.id, quiz.title)">
                      <i class="bi bi-bar-chart me-1"></i> Analytics
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="myQuizzes.length === 0" class="col-12 text-center py-5">
            <img src="assets/img/empty-state.svg" width="150" class="mb-3 opacity-50"
              onerror="this.style.display='none'" />
            <h5 class="text-muted">No exams found</h5>
            <button class="btn btn-link" (click)="openCreateModal()">
              Create your first exam
            </button>
          </div>
        </div>
      </div>

      <!-- 3. REPORTS / GRADEBOOK -->
      <div *ngIf="currentView === 'reports'" class="animate__animated animate__fadeIn">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white py-3">
            <h5 class="m-0 fw-bold">Select an Exam to View Report</h5>
          </div>
          <div class="list-group list-group-flush">
            <button *ngFor="let quiz of myQuizzes"
              class="list-group-item list-group-item-action p-3 d-flex justify-content-between align-items-center"
              (click)="openReportModal(quiz.id, quiz.title)">
              <div>
                <h6 class="mb-0 fw-bold text-primary">{{ quiz.title }}</h6>
                <small class="text-muted">Code: {{ quiz.code }} •
                  {{ quiz.questionsCount }} Questions</small>
              </div>
              <i class="bi bi-chevron-right text-muted"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- 4. SETTINGS -->
      <div *ngIf="currentView === 'settings'" class="animate__animated animate__fadeIn">
        <!-- (Same Settings UI as provided in previous turn) -->
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card shadow-sm border-0">
              <div class="card-body p-5">
                <h4 class="mb-4 fw-bold">Profile Settings</h4>
                <div class="row mb-4">
                  <div class="col-md-3 text-center">
                    <img [src]="
                        imagePreview ||
                        currentUser.profileImageUrl ||
                        'assets/img/default-avatar.png'
                      " class="rounded-circle border shadow-sm" width="100" height="100" style="object-fit: cover" />
                    <label class="btn btn-sm btn-light mt-2 border">
                      Upload
                      <input type="file" hidden (change)="onProfileImageSelected($event)" />
                    </label>
                  </div>
                  <div class="col-md-9">
                    <div class="mb-3">
                      <label class="form-label small fw-bold">Name</label><input type="text" class="form-control"
                        [(ngModel)]="currentUser.name" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label small fw-bold">Email</label><input type="text"
                        class="form-control bg-light" [value]="currentUser.email" disabled />
                    </div>
                    <div class="row mb-3">
                      <div class="col-6">
                        <label class="form-label small text-muted">User Type</label>
                        <div class="form-control bg-white">
                          {{ currentUser.userType }}
                        </div>
                      </div>
                      <div class="col-6">
                        <label class="form-label small text-muted">Institution</label>
                        <div class="form-control bg-white text-truncate">
                          {{ institutionDetails.instituteName }}
                        </div>
                        <div class="form-control bg-white text-truncate">
                          {{ institutionDetails.instituteLocation }}
                        </div>
                      </div>
                    </div>
                    <button class="btn btn-primary" (click)="updateProfile()">
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODALS ==================== -->

<!-- 1. CREATE EXAM MODAL -->
<div class="modal fade" id="createQuizModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold">Create New Exam</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-4">
        <div class="mb-3">
          <label class="form-label fw-bold small">Exam Title</label>
          <input type="text" class="form-control bg-light" placeholder="e.g. Final Physics Exam"
            [(ngModel)]="newQuiz.title" />
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold small">Time Limit (Minutes)</label>
            <input type="number" class="form-control bg-light" [(ngModel)]="newQuiz.timeLimit" />
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold small">Schedule Date</label>
            <input type="date" class="form-control bg-light" [(ngModel)]="newQuiz.scheduledDate" />
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold small">Instructions / Description</label>
          <textarea class="form-control bg-light" rows="3" placeholder="Enter rules for students..."
            [(ngModel)]="newQuiz.description"></textarea>
        </div>
      </div>
      <div class="modal-footer border-top-0 pt-0">
        <button class="btn btn-light fw-bold" data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-primary fw-bold px-4" (click)="createQuiz()">
          Create Exam
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 2. GRADEBOOK / REPORT MODAL -->
<div class="modal fade" id="reportModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-white border-bottom">
        <h5 class="modal-title fw-bold">Report: {{ selectedReportQuiz }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0 bg-light">
        <!-- Filters Toolbar -->
        <div class="p-3 bg-white border-bottom d-flex gap-2">
          <button class="btn btn-sm rounded-pill" [class.btn-dark]="activeFilter === 'ALL'"
            [class.btn-light]="activeFilter !== 'ALL'" (click)="applyFilter('ALL')">
            All
          </button>
          <button class="btn btn-sm rounded-pill" [class.btn-success]="activeFilter === 'PASS'"
            [class.btn-light]="activeFilter !== 'PASS'" (click)="applyFilter('PASS')">
            Passed
          </button>
          <button class="btn btn-sm rounded-pill" [class.btn-danger]="activeFilter === 'FAIL'"
            [class.btn-light]="activeFilter !== 'FAIL'" (click)="applyFilter('FAIL')">
            Failed
          </button>
        </div>

        <!-- Students Table -->
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-secondary small text-uppercase">
              <tr>
                <th class="ps-4">Student</th>
                <th>ID</th>
                <th>Score</th>
                <th>Result</th>
                <th>Date</th>
                <th class="text-end pe-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of filteredParticipants">
                <td class="ps-4 fw-bold">
                  {{ p.name }} <br />
                  <small class="text-muted fw-normal">{{ p.email }}</small>
                </td>
                <!-- Prefer resolvedResultId (normalized). show fallback debug index if missing. -->
                <td>
                  {{
                  p.resolvedResultId || p?.id || p?.resultId || p?._debugIndex
                  }}
                </td>
                <td>
                  <span class="fw-bold">{{ p.score }} / {{ p.totalQuestions }}</span>
                  <div class="progress" style="height: 4px; width: 100px">
                    <div class="progress-bar" [style.width.%]="getPercentage(p.score, p.totalQuestions)" [ngClass]="
                        getPercentage(p.score, p.totalQuestions) >= 50
                          ? 'bg-success'
                          : 'bg-danger'
                      "></div>
                  </div>
                </td>
                <td>
                  <span class="badge rounded-pill" [ngClass]="
                      getPercentage(p.score, p.totalQuestions) >= 50
                        ? 'bg-success-subtle text-success'
                        : 'bg-danger-subtle text-danger'
                    ">
                    {{
                    getPercentage(p.score, p.totalQuestions) >= 50
                    ? "PASS"
                    : "FAIL"
                    }}
                  </span>
                </td>
                <td class="text-muted small">
                  {{ p.date | date : "shortDate" }}
                </td>

                <!-- Actions column: use the normalized resolvedResultId -->
                <td class="text-end pe-4">
                  <button class="btn btn-sm btn-outline-primary"
                    (click)="viewStudentAttempt(p.resolvedResultId || getResultId(p))"
                    [disabled]="!(p.resolvedResultId || getResultId(p))"
                    [title]="(p.resolvedResultId || getResultId(p)) ? 'Open review' : 'Missing result id — check backend'">
                    Review Answers
                  </button>
                </td>
              </tr>

              <tr *ngIf="filteredParticipants.length === 0">
                <td colspan="6" class="text-center py-5 text-muted">
                  No student records found.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 3. INDIVIDUAL STUDENT ANSWER REVIEW MODAL -->
<div class="modal fade" id="studentReviewModal" tabindex="-1" style="z-index: 1060">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <!-- Corrected studentReviewModal header (remove stray button that referenced `p`) -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Answer Review</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body bg-light" *ngIf="studentReview">
        <div class="mb-3 p-3 bg-white rounded shadow-sm">
          <h5 class="fw-bold">{{ studentReview.quizTitle }}</h5>
          <p class="mb-0">
            Student Score:
            <strong class="text-primary">{{ studentReview.score }} /
              {{ studentReview.totalQuestions }}</strong>
          </p>
        </div>

        <div *ngFor="let q of studentReview.questions; let i = index" class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <h6 class="fw-bold">Q{{ i + 1 }}: {{ q.content }}</h6>
            <div *ngIf="q.type === 'MCQ'">
              <div *ngFor="let opt of q.options" class="p-2 rounded border mb-1" [ngClass]="{
                  'bg-success-subtle border-success text-success fw-bold':
                    opt === q.correctAnswer,
                  'bg-danger-subtle border-danger text-danger':
                    studentReview.userAnswers[q.id] === opt &&
                    opt !== q.correctAnswer,
                  'text-muted':
                    studentReview.userAnswers[q.id] !== opt &&
                    opt !== q.correctAnswer
                }">
                <i class="bi" [ngClass]="
                    opt === q.correctAnswer
                      ? 'bi-check-circle-fill'
                      : studentReview.userAnswers[q.id] === opt
                      ? 'bi-x-circle-fill'
                      : 'bi-circle'
                  "></i>
                {{ opt }}
              </div>
            </div>
            <div *ngIf="q.type === 'CODING'" class="alert alert-secondary small mt-2">
              Coding Question - Manual Review Required
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>