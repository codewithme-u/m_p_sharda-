<div class="secure-page-container">

  <nav *ngIf="quizStarted && !isSubmitted" class="navbar navbar-dark shadow-sm fixed-top"
       [ngClass]="isViolating ? 'bg-danger' : 'bg-dark'">
    <div class="container-fluid">
      <div class="navbar-brand">
        <h5 class="m-0" [class.text-white]="!isViolating" [class.text-warning]="isViolating">
            <i class="bi bi-shield-lock-fill me-2"></i>
            {{ isViolating ? 'VIOLATION ACTIVE' : 'PROCTORING ACTIVE' }}
        </h5>
      </div>
      <div class="d-flex text-white fw-bold">
        <span class="me-4" title="Time Remaining">
          <i class="bi bi-clock-fill"></i> {{ formatTime(timeLeft) }}
        </span>
        <span [ngClass]="proctoringViolations > 0 ? 'text-warning' : 'text-success'" title="Violation Count">
          <i class="bi bi-eye-fill"></i> STRIKES: {{ proctoringViolations }} / {{ maxViolations }}
        </span>
      </div>
    </div>
  </nav>

  <div *ngIf="isViolating && quizStarted" class="alert alert-danger text-center m-0 py-2 fw-bold fixed-top mt-5" style="z-index: 1000;" role="alert">
    CRITICAL MISBEHAVIOR DETECTED! Return focus to the quiz immediately. Auto-submission pending in {{ gracePeriodSeconds }} seconds.
  </div>

  <div class="container py-5">
    
    <div *ngIf="errorMessage" class="text-center mt-5 animate__animated animate__fadeIn">
      <div class="text-white rounded-circle d-inline-flex p-4 mb-3 shadow"
           [ngClass]="errorTitle === 'Access Denied' ? 'bg-danger' : 'bg-secondary'">
        <i class="bi" [ngClass]="errorTitle === 'Access Denied' ? 'bi-shield-lock-fill' : 'bi-exclamation-triangle-fill'" style="font-size: 3rem;"></i>
      </div>
      <h3 class="fw-bold" [class.text-danger]="errorTitle === 'Access Denied'">{{ errorTitle }}</h3>
      <p class="lead text-muted">{{ errorMessage }}</p>
      <button class="btn btn-outline-dark mt-3 px-4" (click)="goHome()">Go to Dashboard</button>
    </div>

    <div *ngIf="!loading && !errorMessage && !quizStarted" class="card shadow-lg border-0 mx-auto text-center p-5" style="max-width: 500px;">
      <h3 class="fw-bold mb-3">Begin Your Exam</h3>
      <p class="text-danger fw-bold">⚠️ CRITICAL SECURITY WARNING:</p>
      <p class="text-muted small">
        The application is now in lockdown mode. Any attempt to minimize, switch tabs, exit fullscreen, 
        or open **Developer Tools (Inspect/Right-Click)** will result in an immediate violation and **auto-submission** of your exam.
      </p>
      <button class="btn btn-primary mt-4 px-5 fw-bold" (click)="startQuiz()">
        Start Exam & Enter Fullscreen
      </button>
    </div>

    <div *ngIf="!loading && !errorMessage && quizStarted && !isSubmitted" class="card shadow-lg border-0 mx-auto mt-5 pt-3" style="max-width: 700px;">
      
      <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h4 class="m-0">Question {{ currentQuestionIndex + 1 }} of {{ questions.length }}</h4>
      </div>
      
      <div class="card-body p-5">
        
        <h5 class="fw-bold mb-4">{{ questions[currentQuestionIndex].content }}</h5>

        <div *ngIf="questions[currentQuestionIndex].type === 'MCQ'" class="d-grid gap-3">
          <button *ngFor="let opt of questions[currentQuestionIndex].options" 
                  class="btn btn-lg text-start border"
                  [class.btn-primary]="selectedOptions[questions[currentQuestionIndex].id] === opt"
                  [class.btn-light]="selectedOptions[questions[currentQuestionIndex].id] !== opt"
                  (click)="selectOption(questions[currentQuestionIndex].id, opt)">
            {{ opt }}
          </button>
        </div>

        <div *ngIf="questions[currentQuestionIndex].type === 'CODING'">
          <textarea class="form-control font-monospace bg-light" rows="6" placeholder="// Write your code here..."></textarea>
        </div>

      </div>
      <div class="card-footer bg-white py-3 d-flex justify-content-between">
        <button class="btn btn-outline-secondary" (click)="prevQuestion()" [disabled]="currentQuestionIndex === 0">Previous</button>
        
        <button *ngIf="currentQuestionIndex < questions.length - 1" class="btn btn-primary px-4" (click)="nextQuestion()">Next</button>
        
        <button *ngIf="currentQuestionIndex === questions.length - 1" class="btn btn-success px-4 fw-bold" (click)="submitQuiz()">Submit Quiz</button>
      </div>
    </div>

    <div *ngIf="isSubmitted" class="text-center animate__animated animate__fadeInUp">
      <div class="card shadow border-0 mx-auto p-5" style="max-width: 500px;">
        <div class="display-1 text-success mb-3"><i class="bi bi-trophy-fill"></i></div>
        <h2 class="fw-bold mb-3">Quiz Completed!</h2>
        <p class="lead text-muted">You scored</p>
        <h1 class="display-3 fw-bold text-primary">{{ score }} / {{ questions.length }}</h1>
        <button class="btn btn-primary mt-4 px-5" (click)="goHome()">Go to Dashboard</button>
      </div>
    </div>

  </div>
</div>

<style>
/* Global CSS for proctoring mode */
.secure-page-container {
    user-select: none; 
    pointer-events: auto; 
    min-height: 100vh;
}
.navbar.fixed-top {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1050; 
}
.container.py-5 {
    padding-top: 80px !important; 
}
</style>
